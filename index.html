<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Annas Chat - WhatsApp Reimagined</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Noto+Sans:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    /* ---------------------------------- Global Styles ---------------------------------- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --whatsapp-primary: #075E54; /* Dark Green */
      --whatsapp-secondary: #128C7E; /* Teal Green */
      --whatsapp-bubble-sent: #DCF8C6; /* Light Green */
      --whatsapp-bubble-received: #FFFFFF; /* White */
      --whatsapp-bg: #ECE5DD; /* Light Grey Chat Background */
      --whatsapp-dark-bg: #111B21; /* Dark Chat Background */
      --whatsapp-dark-sidebar: #1F2C34; /* Dark Sidebar */
      --whatsapp-dark-header: #202C33; /* Dark Header */
      --whatsapp-input-bg: #F0F2F5; /* Light Grey Input */
      --whatsapp-dark-input: #2A3942; /* Dark Input */
      --text-dark: #333;
      --text-light: #fff;
      --border-light: #e0e0e0;
      --shadow-light: rgba(0, 0, 0, 0.1);
      --shadow-heavy: rgba(0, 0, 0, 0.25);
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #007bff;
      --gemini-color: #4CAF50;
      --instagram-blue: #0095f6; /* For verified badge */
      --wa-online-status: #4CAF50;

      /* Hacker Effect Colors */
      --hacker-green: #00FF00;
      --hacker-dark: #0A0A0A;
      --hacker-light-green: #0F0;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--whatsapp-dark-bg); /* Use dark background for body */
      color: var(--text-dark);
      height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background-color 0.5s ease;
      position: relative; /* For modal overlay */
    }

    /* ---------------------------------- General Container Styling ---------------------------------- */
    .app-screen {
        width: 100%;
        height: 100%;
        display: none; /* Controlled by JS */
        position: absolute;
        top: 0;
        left: 0;
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
    }
    .app-screen.active {
        display: flex;
        transform: translateY(0);
        opacity: 1;
    }
    .app-screen.transition-out {
        transform: translateY(-20px);
        opacity: 0;
    }

    /* ---------------------------------- Loading Screen ---------------------------------- */
    #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--hacker-dark); /* Dark background for hacker effect */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        color: var(--hacker-green);
        font-size: 1.5em;
        font-weight: 600;
        transition: opacity 0.5s ease;
        opacity: 0; /* Initially hidden */
        pointer-events: none;
        overflow: hidden;
    }
    #loading-screen.show {
        opacity: 1;
        pointer-events: all;
    }

    .hacker-console {
        font-family: 'Press Start 2P', cursive;
        font-size: 0.9em;
        text-align: left;
        width: 80%;
        max-width: 600px;
        margin-bottom: 30px;
        color: var(--hacker-light-green);
        text-shadow: 0 0 5px var(--hacker-green);
        white-space: pre-wrap; /* Preserve line breaks and spaces */
        overflow: hidden;
        border-right: 0.15em solid var(--hacker-green); /* blinking cursor */
        animation: typing 3.5s steps(40, end) forwards, blink-caret 0.75s step-end infinite;
    }

    @keyframes typing {
        from { width: 0; }
        to { width: 100%; }
    }

    @keyframes blink-caret {
        from, to { border-color: transparent; }
        50% { border-color: var(--hacker-green); }
    }

    .person-walk {
        width: 120px;
        height: 120px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 2C10.9 2 10 2.9 10 4s.9 2 2 2 2-.9 2-2-.9-2-2-2zM21 16v-2h-3v-3c0-.55-.45-1-1-1s-1 .45-1 1v3h-2v-3c0-.55-.45-1-1-1s-1 .45-1 1v3h-2v-3c0-.55-.45-1-1-1s-1 .45-1 1v3H3v2h2.5L7 21h2l-2.5-5h2.5L12 21h2l-2.5-5h2.5L17 21h2l-2.5-5H21z"/></svg>'); /* Simple walking person SVG */
        background-size: contain;
        background-repeat: no-repeat;
        animation: walk 1.5s infinite steps(2); /* Slower, smoother walk */
        margin-bottom: 25px;
        filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3));
    }

    @keyframes walk {
        0% { transform: translateX(-30px) rotateY(0deg); }
        50% { transform: translateX(30px) rotateY(0deg); }
        51% { transform: translateX(30px) rotateY(180deg); }
        100% { transform: translateX(-30px) rotateY(180deg); }
    }
    
    /* ---------------------------------- Auth Screen (Login/Register) ---------------------------------- */
    #auth-screen {
        display: flex; /* Always display as flex to center card */
        justify-content: center;
        align-items: center;
        height: 100%;
        width: 100%;
        position: relative;
        z-index: 10;
        background: var(--whatsapp-dark-bg);
    }

    .card {
      background: var(--whatsapp-dark-sidebar); /* Darker card for auth */
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 15px 40px var(--shadow-heavy);
      max-width: 480px;
      width: 90%;
      margin: auto;
      backdrop-filter: blur(10px);
      transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      transform: scale(0.95) translateY(10px);
      opacity: 0;
      animation: fadeInZoomIn 0.8s forwards ease-out;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-light);
    }

    @keyframes fadeInZoomIn {
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    .card h2 {
      text-align: center;
      margin-bottom: 30px;
      color: var(--whatsapp-secondary);
      font-weight: 900;
      font-size: 2.2em;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    input[type="text"],
    input[type="password"],
    input[type="email"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 16px 20px;
      margin: 15px 0;
      font-size: 1.05em;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.15);
      background-color: var(--whatsapp-dark-input);
      color: var(--text-light);
      transition: all 0.3s ease;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.06);
      font-family: 'Roboto', sans-serif;
      resize: vertical;
      min-height: 55px; /* For textarea */
    }
    input[type="text"]::placeholder,
    input[type="password"]::placeholder,
    textarea::placeholder {
        color: #889094;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="email"]:focus,
    input[type="number"]:focus,
    textarea:focus {
      border-color: var(--whatsapp-secondary);
      box-shadow: 0 0 0 4px rgba(18, 140, 126, 0.3);
      outline: none;
      background-color: #32404A; /* Slightly lighter on focus */
    }

    button {
      width: 100%;
      padding: 18px;
      margin-top: 25px;
      font-size: 1.2em;
      border-radius: 12px;
      border: none;
      background: linear-gradient(45deg, var(--whatsapp-primary), var(--whatsapp-secondary));
      color: var(--text-light);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: hidden;
      z-index: 1;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 200%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      z-index: -1;
      transition: transform 0.5s ease;
      transform: skewX(-20deg);
    }

    button:hover::before {
      transform: skewX(-20deg) translateX(120%);
    }

    button:hover {
      transform: translateY(-3px) scale(1.01);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.3);
      background: linear-gradient(45deg, var(--whatsapp-secondary), var(--whatsapp-primary));
    }

    .link {
      color: var(--whatsapp-secondary);
      cursor: pointer;
      text-align: center;
      margin-top: 20px;
      display: block;
      font-size: 1em;
      transition: color 0.3s ease, text-decoration 0.3s ease;
      font-weight: 500;
    }

    .link:hover {
      color: var(--whatsapp-primary);
      text-decoration: underline;
    }

    .message {
      color: var(--danger-color);
      text-align: center;
      margin-top: 15px;
      font-weight: 600;
      font-size: 1em;
    }

    /* ---------------------------------- Main Chat List Screen ---------------------------------- */
    #main-chat-list-screen {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
        max-width: 500px; /* Simulate phone width */
        background: var(--whatsapp-dark-bg);
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        border-radius: 10px;
        overflow: hidden;
        margin: auto;
    }
    
    #main-chat-list-header {
        background: var(--whatsapp-dark-header);
        color: var(--text-light);
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.5em;
        font-weight: 700;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #main-chat-list-header .app-title {
        color: var(--whatsapp-secondary);
        font-size: 1.1em;
        font-weight: 800;
    }
    #main-chat-list-header .header-icons i {
        margin-left: 20px;
        cursor: pointer;
        color: #B0B0B0;
        transition: color 0.2s ease;
    }
    #main-chat-list-header .header-icons i:hover {
        color: var(--text-light);
    }

    #promo-banner {
        background: #233138;
        color: #ccc;
        padding: 12px 20px;
        font-size: 0.9em;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    #promo-banner a {
        color: var(--whatsapp-secondary);
        text-decoration: none;
        font-weight: 600;
        margin-left: 5px;
    }
    #promo-banner .close-btn {
        background: none;
        border: none;
        color: #aaa;
        font-size: 1.2em;
        cursor: pointer;
        padding: 0;
        width: auto;
        margin-top: 0;
        box-shadow: none;
    }

    #chat-list-content {
        flex: 1;
        overflow-y: auto;
        background: var(--whatsapp-dark-bg);
        padding-top: 10px;
    }

    .chat-list-item {
      display: flex;
      align-items: center;
      padding: 12px 18px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      cursor: pointer;
      transition: background-color 0.2s ease;
      color: var(--text-light);
      position: relative;
    }
    .chat-list-item:hover {
      background-color: rgba(255,255,255,0.05);
    }

    .chat-list-item .avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: #555;
      margin-right: 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-light);
      font-weight: 600;
      font-size: 1.2em;
      flex-shrink: 0;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.2);
    }
    .chat-list-item .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .chat-list-item .chat-info {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    .chat-list-item .chat-name {
      font-weight: 600;
      font-size: 1.05em;
      display: flex;
      align-items: center;
    }
    .chat-list-item .chat-name .admin-badge {
        color: var(--instagram-blue);
        font-size: 0.8em;
        margin-left: 5px;
    }
    .chat-list-item .last-message {
      font-size: 0.9em;
      color: #B0B0B0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: calc(100% - 70px); /* Adjust based on timestamp width */
    }
    .chat-list-item .chat-meta {
      font-size: 0.8em;
      color: #888;
      margin-left: auto;
      text-align: right;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    .chat-list-item .timestamp {
        color: #888;
    }
    .chat-list-item .unread-count {
        background: #25D366; /* WhatsApp unread dot */
        color: var(--text-light);
        font-size: 0.7em;
        font-weight: 700;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 5px;
    }

    /* ---------------------------------- Bottom Navigation ---------------------------------- */
    #bottom-nav {
        display: flex;
        background: var(--whatsapp-dark-header);
        border-top: 1px solid rgba(255,255,255,0.05);
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        flex-shrink: 0;
    }
    .nav-item {
        flex: 1;
        text-align: center;
        padding: 12px 0;
        color: #B0B0B0;
        font-size: 0.8em;
        cursor: pointer;
        transition: color 0.2s ease, background-color 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .nav-item i {
        font-size: 1.5em;
        margin-bottom: 5px;
    }
    .nav-item.active {
        color: var(--whatsapp-secondary);
        font-weight: 700;
    }
    .nav-item:hover {
        background-color: rgba(255,255,255,0.05);
    }
    .nav-item.active i {
        transform: scale(1.1);
        transition: transform 0.2s ease;
    }
    /* Floating action button */
    #fab-chat {
        position: absolute;
        bottom: 75px; /* Above nav bar */
        right: 25px;
        background: var(--whatsapp-secondary);
        color: var(--text-light);
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.8em;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        z-index: 100;
    }
    #fab-chat:hover {
        background: var(--whatsapp-primary);
        transform: translateY(-5px) rotate(5deg) scale(1.05);
    }


    /* ---------------------------------- Individual Chat Screen ---------------------------------- */
    #individual-chat-screen {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
        max-width: 500px; /* Simulate phone width */
        background: var(--whatsapp-dark-bg);
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        border-radius: 10px;
        overflow: hidden;
        margin: auto;
    }

    #chat-header {
      background: var(--whatsapp-dark-header);
      color: var(--text-light);
      padding: 10px 15px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      flex-shrink: 0;
      position: relative;
      z-index: 50;
    }

    #chat-header .back-btn {
        background: none;
        border: none;
        color: var(--text-light);
        font-size: 1.5em;
        margin-right: 15px;
        cursor: pointer;
        padding: 5px;
    }

    #chat-header .chat-partner-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #555;
        display: flex;
        justify-content: center;
        align-items: center;
        color: var(--text-light);
        font-weight: 600;
        font-size: 1.1em;
        flex-shrink: 0;
        overflow: hidden;
        border: 2px solid rgba(255,255,255,0.2);
    }
    #chat-header .chat-partner-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    #chat-header .chat-partner-info {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        margin-left: 10px;
    }

    #chat-header .chat-partner-name {
        font-size: 1.1em;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    #chat-header .chat-partner-name .admin-badge {
        color: var(--instagram-blue);
        font-size: 0.8em;
        filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2));
    }
    #chat-header .chat-partner-status {
        font-size: 0.75em;
        font-weight: 400;
        opacity: 0.9;
        color: #B0B0B0;
    }
    #chat-header .chat-options {
      display: flex;
      gap: 5px;
      margin-left: auto;
    }

    #chat-header .chat-options button {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 1.2em;
      padding: 8px;
      border-radius: 50%;
      transition: background-color 0.2s ease;
      box-shadow: none;
      margin: 0;
      width: 40px;
      height: 40px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    #chat-header .chat-options button:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* End-to-end encryption notice */
    .e2e-notice {
        background-color: #1F2C34; /* Darker than chat background */
        color: #B0B0B0;
        font-size: 0.85em;
        padding: 10px 20px;
        text-align: center;
        margin: 0 auto;
        border-radius: 8px;
        max-width: 90%;
        position: sticky;
        top: 10px; /* Stay at top of scrollable area */
        z-index: 10;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .e2e-notice i {
        margin-right: 5px;
        color: var(--whatsapp-secondary);
    }
    .e2e-notice a {
        color: var(--whatsapp-secondary);
        text-decoration: none;
        font-weight: 500;
    }
    .e2e-notice a:hover {
        text-decoration: underline;
    }

    #chat-messages {
      flex: 1;
      padding: 10px 15px;
      overflow-y: auto;
      background: var(--whatsapp-dark-bg);
      display: flex;
      flex-direction: column;
      gap: 6px;
      scroll-behavior: smooth;
      background-image: url('data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="%23222B32" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM15 10c0-1.66-1.34-3-3-3s-3 1.34-3 3 1.34 3 3 3 3-1.34 3-3z"/></svg>'); /* Darker WA-like pattern */
      background-size: 120px; /* Adjust for density */
      background-repeat: repeat;
    }
    #chat-messages::before {
        content: '';
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        height: 10px; /* Small fade at top */
        background: linear-gradient(to bottom, rgba(17,27,33,1), rgba(17,27,33,0));
        z-index: 5;
        pointer-events: none;
    }
    #chat-messages::after {
        content: '';
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        height: 10px; /* Small fade at bottom */
        background: linear-gradient(to top, rgba(17,27,33,1), rgba(17,27,33,0));
        z-index: 5;
        pointer-events: none;
    }


    /* ---------------------------------- Message Bubbles ---------------------------------- */
    .msg-bubble {
      margin: 0;
      padding: 8px 10px;
      max-width: 80%; /* Increased max width */
      border-radius: 8px; /* WA-like sharp corners */
      word-wrap: break-word;
      font-size: 0.9em;
      line-height: 1.3;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.1); /* Softer shadow */
      position: relative;
      animation: fadeInMessage 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      transform-origin: bottom;
      color: #E0E0E0; /* Default text color for dark theme */
    }

    @keyframes fadeInMessage {
      from { opacity: 0; transform: translateY(8px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .msg-user {
      background: var(--whatsapp-bubble-sent); /* Light green for sent */
      color: var(--text-dark); /* Dark text for light bubble */
      align-self: flex-end;
      text-align: right;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      border-bottom-right-radius: 4px; /* Slightly less rounded */
      border-bottom-left-radius: 8px;
    }

    .msg-bot {
      background: var(--whatsapp-dark-input); /* Darker grey for received */
      color: var(--text-light);
      align-self: flex-start;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      border-bottom-left-radius: 4px; /* Slightly less rounded */
      border-bottom-right-radius: 8px;
    }

    /* WhatsApp-like message tails */
    .msg-user::after {
      content: '';
      position: absolute;
      bottom: 0;
      right: -8px;
      width: 12px;
      height: 19px;
      background: var(--whatsapp-bubble-sent);
      border-bottom-left-radius: 100%;
      border-top-right-radius: 0;
      border-top-left-radius: 100%;
      transform: rotate(20deg) skewX(20deg);
      z-index: -1;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.1);
    }

    .msg-bot::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: -8px;
      width: 12px;
      height: 19px;
      background: var(--whatsapp-dark-input);
      border-bottom-right-radius: 100%;
      border-top-left-radius: 0;
      border-top-right-radius: 100%;
      transform: rotate(-20deg) skewX(-20deg);
      z-index: -1;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.1);
    }

    .msg-bubble img,
    .msg-bubble audio,
    .msg-bubble video {
      max-width: 100%;
      border-radius: 6px;
      display: block;
      margin-top: 3px;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.15);
    }

    .msg-timestamp {
      font-size: 0.65em;
      color: #888;
      margin-top: 2px;
      display: block;
      opacity: 0.8;
      float: right; /* Align timestamp to right inside bubble */
      margin-left: 10px;
    }
    .msg-user .msg-timestamp {
      color: #666;
    }
    .msg-bot .msg-timestamp {
        color: #B0B0B0;
    }


    /* ---------------------------------- Chat Input Bar ---------------------------------- */
    #chat-input-bar {
      display: flex;
      padding: 8px 12px;
      background: var(--whatsapp-dark-bg);
      align-items: center;
      gap: 5px;
      flex-shrink: 0;
    }

    #chat-input-bar .input-icons {
        display: flex;
        gap: 5px;
    }

    #chat-input-bar .input-icons button {
        background: none;
        border: none;
        color: #B0B0B0;
        font-size: 1.3em;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        transition: color 0.2s ease, background-color 0.2s ease;
        padding: 0;
        margin: 0;
        box-shadow: none;
    }
    #chat-input-bar .input-icons button:hover {
        color: var(--text-light);
        background-color: rgba(255,255,255,0.08);
        transform: none; /* Override general button hover */
    }

    #chat-input-bar .message-input-wrapper {
        flex: 1;
        position: relative;
    }
    #chat-input-bar input[type="text"] {
        width: 100%;
        padding: 10px 40px 10px 15px; /* Adjust for smiley icon */
        border-radius: 20px;
        border: none;
        background-color: var(--whatsapp-dark-input);
        color: var(--text-light);
        font-size: 0.95em;
        transition: all 0.2s ease;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        min-height: 40px; /* Ensure input height is adequate */
        margin: 0; /* Override default input margin */
    }
    #chat-input-bar input[type="text"]::placeholder {
        color: #889094;
    }
    #chat-input-bar input[type="text"]:focus {
        background-color: #32404A; /* Slightly lighter on focus */
        box-shadow: 0 0 0 2px var(--whatsapp-secondary);
    }
    #chat-input-bar .smiley-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #B0B0B0;
        cursor: pointer;
        font-size: 1.2em;
    }

    #chat-input-bar input[type="file"] {
      display: none;
    }

    #chat-input-bar .mic-send-button {
      background: var(--whatsapp-secondary);
      color: var(--text-light);
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.3em;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      margin: 0; /* Override default button margin */
      padding: 0; /* Override default button padding */
    }
    #chat-input-bar .mic-send-button:hover {
      background: var(--whatsapp-primary);
      transform: scale(1.05);
    }

    /* ---------------------------------- Modal Styles (Used for all popups) ---------------------------------- */
    #modal-backdrop {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.75);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    #modal-backdrop.show {
      opacity: 1;
      pointer-events: all;
    }

    #modal-content {
      background: var(--whatsapp-dark-bg);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 15px 40px var(--shadow-heavy);
      max-width: 400px;
      width: 90%;
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-light);
    }

    #modal-backdrop.show #modal-content {
      transform: scale(1);
      opacity: 1;
    }

    #modal-title {
      margin-bottom: 20px;
      text-align: center;
      color: var(--whatsapp-secondary);
      font-weight: 700;
      font-size: 1.6em;
    }

    #modal-body p {
      margin-bottom: 12px;
      line-height: 1.5;
      color: #ccc;
    }

    #modal-body input, #modal-body textarea, #modal-body select {
      margin-bottom: 10px;
      background-color: var(--whatsapp-dark-input);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text-light);
    }
    #modal-body input::placeholder, #modal-body textarea::placeholder {
        color: #889094;
    }


    #modal-actions {
      margin-top: 25px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    #modal-actions button {
      width: auto;
      padding: 10px 20px;
      font-size: 0.95em;
      margin: 0;
      border-radius: 10px;
      box-shadow: none;
      background: #444; /* Default dark background for modal buttons */
      color: var(--text-light);
      font-weight: 500;
    }

    #modal-actions button.cancel-btn { background: #555; }
    #modal-actions button.confirm-btn { background: var(--whatsapp-secondary); }
    #modal-actions button.confirm-btn:hover { background: var(--whatsapp-primary); }
    #modal-actions button.danger { background: var(--danger-color); }
    #modal-actions button.success { background: var(--success-color); }
    #modal-actions button.info { background: var(--info-color); }

    .profile-pic-upload-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
    }
    .profile-pic-preview {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background-color: #555;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        margin-bottom: 10px;
        border: 3px solid var(--whatsapp-secondary);
        box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }
    .profile-pic-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .profile-pic-preview .initials {
        font-size: 3em;
        font-weight: bold;
        color: var(--text-light);
    }
    .upload-btn {
        background: var(--info-color);
        color: white;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85em;
        margin: 0;
        width: auto;
        display: inline-flex;
        align-items: center;
        box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        font-weight: 500;
    }
    .upload-btn:hover {
        background: #0069d9;
        transform: translateY(-1px);
    }

    .admin-controls-modal {
        max-width: 550px !important;
    }
    .controls-panel {
        background: #1F2C34; /* Darker background for panels */
        padding: 20px;
        border-radius: 12px;
        margin-top: 15px;
        border: 1px solid rgba(255,255,255,0.08);
    }
    .controls-panel h4 {
        color: var(--whatsapp-secondary);
        margin-bottom: 15px;
        font-size: 1.2em;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 8px;
    }
    .controls-panel button {
        margin-bottom: 8px;
        padding: 12px;
        font-size: 0.95em;
        border-radius: 10px;
        background: #444;
        color: var(--text-light);
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    .controls-panel button i { margin-right: 8px; }
    .controls-panel button.danger { background: var(--danger-color); }
    .controls-panel button.success { background: var(--success-color); }
    .controls-panel button.info { background: var(--info-color); }
    .controls-panel button.default { background: #6c757d; }

    .review-request-item {
        background: #2A3942;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 8px;
        font-size: 0.9em;
        color: #ddd;
    }
    .review-request-item strong {
        color: var(--whatsapp-secondary);
    }
    .review-request-item .actions button {
        margin-top: 8px;
        padding: 6px 12px;
        font-size: 0.8em;
        border-radius: 6px;
        width: auto;
        margin-right: 5px;
        box-shadow: none;
    }
    .stats {
        font-size: 0.85em;
        background: #2A3942;
        padding: 12px;
        margin-top: 15px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1);
        color: #ddd;
        line-height: 1.6;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
    }
    .modal-scrollable-content {
        max-height: 300px;
        overflow-y: auto;
        padding-right: 5px; /* For scrollbar space */
    }

    /* ---------------------------------- Call Screen (Simulated) ---------------------------------- */
    #call-screen {
        display: none; /* Controlled by JS */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: linear-gradient(to top left, #075E54, #128C7E); /* Dark gradient for call screen */
        color: var(--text-light);
        font-size: 1.5em;
        font-weight: 500;
        text-align: center;
    }
    #call-screen .call-avatar {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background-color: #555;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        margin-bottom: 20px;
        border: 5px solid rgba(255,255,255,0.3);
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    #call-screen .call-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    #call-screen .call-avatar .initials {
        font-size: 4em;
    }
    #call-screen .call-status {
        font-size: 0.8em;
        opacity: 0.8;
        margin-top: 5px;
    }
    #call-screen .call-controls {
        display: flex;
        gap: 30px;
        margin-top: 40px;
    }
    #call-screen .call-controls button {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        font-size: 1.8em;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    #call-screen .call-controls .end-call-btn {
        background: var(--danger-color);
    }
    #call-screen .call-controls .mute-btn,
    #call-screen .call-controls .speaker-btn {
        background: rgba(255,255,255,0.2);
        color: var(--text-light);
    }
    #call-screen .call-controls button:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }

    /* ---------------------------------- Admin & User Controls Screen ---------------------------------- */
    #admin-user-controls-screen {
        display: none;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
        max-width: 500px; /* Simulate phone width */
        background: var(--whatsapp-dark-bg);
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        border-radius: 10px;
        overflow: hidden;
        margin: auto;
    }
    #admin-user-controls-screen .controls-header {
        background: var(--whatsapp-dark-header);
        color: var(--text-light);
        padding: 15px 20px;
        display: flex;
        align-items: center;
        font-size: 1.5em;
        font-weight: 700;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        flex-shrink: 0;
    }
    #admin-user-controls-screen .controls-header .back-btn {
        background: none;
        border: none;
        color: var(--text-light);
        font-size: 1.5em;
        margin-right: 15px;
        cursor: pointer;
        padding: 5px;
    }
    #admin-user-controls-screen .controls-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        color: #ccc;
    }
    #admin-user-controls-screen .controls-body button {
        background: #32404A;
        color: var(--text-light);
        margin-bottom: 10px;
        padding: 15px;
        font-size: 1em;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #admin-user-controls-screen .controls-body button i {
        margin-right: 10px;
        font-size: 1.1em;
    }
    #admin-user-controls-screen .controls-body button.danger { background: var(--danger-color); }
    #admin-user-controls-screen .controls-body button.success { background: var(--success-color); }
    #admin-user-controls-screen .controls-body button.info { background: var(--info-color); }

    /* ---------------------------------- UGD Screen ---------------------------------- */
    #ugd-screen {
        display: none;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
        max-width: 500px;
        background: linear-gradient(135deg, #FF6B6B, #EE4D4D, #CC0000); /* Emergency Red Gradient */
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        border-radius: 10px;
        margin: auto;
        justify-content: center;
        align-items: center;
        color: var(--text-light);
        text-align: center;
    }
    #ugd-screen .ugd-header {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        background: rgba(0,0,0,0.3);
        padding: 15px;
        font-size: 1.8em;
        font-weight: 700;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    #ugd-screen .ugd-header .back-btn {
        position: absolute;
        left: 15px;
        background: none;
        border: none;
        color: var(--text-light);
        font-size: 1.5em;
        cursor: pointer;
    }

    #ugd-screen .ugd-icon {
        font-size: 8em;
        margin-bottom: 30px;
        color: var(--text-light);
        text-shadow: 0 0 15px rgba(255,255,255,0.5);
        animation: pulse 1.5s infinite ease-in-out;
    }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }

    #ugd-screen h2 {
        font-size: 2.5em;
        margin-bottom: 15px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    #ugd-screen p {
        font-size: 1.1em;
        margin-bottom: 40px;
        max-width: 80%;
        line-height: 1.4;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    #ugd-screen .ugd-buttons {
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 80%;
        max-width: 350px;
    }
    #ugd-screen .ugd-buttons button {
        padding: 20px;
        font-size: 1.4em;
        border-radius: 15px;
        background: rgba(255,255,255,0.2);
        border: 2px solid rgba(255,255,255,0.5);
        color: var(--text-light);
        font-weight: bold;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
    }
    #ugd-screen .ugd-buttons button:hover {
        background: rgba(255,255,255,0.3);
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    }
    #ugd-screen .ugd-buttons button i {
        margin-right: 15px;
        font-size: 1.2em;
    }

    /* ---------------------------------- Responsive Design (Mobile First) ---------------------------------- */
    @media (max-width: 768px) {
      body {
        align-items: flex-start;
        padding: 0;
      }
      .card {
        border-radius: 0; /* Full width on mobile auth */
        height: 100%;
        width: 100%;
        max-width: none;
        padding: 30px;
        box-shadow: none;
        animation: none; /* No initial zoom-in for full screen */
        transform: none;
      }
      .card h2 {
        font-size: 1.8em;
      }
      input[type="text"], input[type="password"], textarea {
        padding: 14px 18px;
        margin: 10px 0;
        font-size: 0.95em;
        border-radius: 10px;
      }
      button {
        padding: 14px;
        font-size: 1.1em;
        border-radius: 10px;
        margin-top: 15px;
      }

      #main-chat-list-screen,
      #individual-chat-screen,
      #admin-user-controls-screen,
      #call-screen,
      #ugd-screen {
        max-width: none;
        border-radius: 0;
        height: 100vh;
        width: 100vw;
      }
      #main-chat-list-header, #chat-header {
        padding: 10px 15px;
        font-size: 1.3em;
      }
      .chat-list-item {
        padding: 10px 15px;
      }
      .chat-list-item .avatar {
        width: 45px;
        height: 45px;
      }
      #chat-messages {
        padding: 8px 12px;
      }
      .msg-bubble {
        padding: 7px 9px;
        font-size: 0.85em;
      }
      #chat-input-bar {
        padding: 6px 10px;
      }
      #chat-input-bar input[type="text"] {
        padding: 8px 35px 8px 12px;
        font-size: 0.9em;
        min-height: 38px;
      }
      #chat-input-bar .input-icons button {
        width: 32px;
        height: 32px;
        font-size: 1.2em;
      }
      #chat-input-bar .mic-send-button {
        width: 42px;
        height: 42px;
        font-size: 1.2em;
      }
      #fab-chat {
        bottom: 65px;
        right: 20px;
        width: 55px;
        height: 55px;
        font-size: 1.6em;
      }

      #modal-content {
        max-width: 95%;
        padding: 25px;
        border-radius: 10px;
      }
      #modal-title {
        font-size: 1.4em;
        margin-bottom: 15px;
      }
      #modal-actions button {
        padding: 8px 15px;
        font-size: 0.85em;
      }
      .profile-pic-preview {
        width: 90px;
        height: 90px;
      }
      .profile-pic-preview .initials {
        font-size: 2.8em;
      }
      .upload-btn {
        padding: 6px 12px;
        font-size: 0.8em;
      }

      #ugd-screen h2 {
        font-size: 1.8em;
      }
      #ugd-screen p {
        font-size: 1em;
      }
      #ugd-screen .ugd-buttons button {
        font-size: 1.1em;
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div id="loading-screen">
    <pre class="hacker-console" id="hacker-console"></pre>
    <div class="person-walk"></div>
    <span id="loading-text">Memuat Annas Chat...</span>
  </div>

  <div id="auth-screen" class="app-screen active">
    <div class="login-form card" id="login-card">
      <h2>Masuk ke Annas Chat</h2>
      <input id="login-username" type="text" placeholder="Username Anda">
      <input id="login-password" type="password" placeholder="Password Anda">
      <button onclick="login()">Login</button>
      <p class="link" onclick="toggleAuthScreen('register')">Belum punya akun? Daftar sekarang</p>
      <p id="login-msg" class="message"></p>
    </div>
    <div class="register-form card" id="register-card" style="display:none">
      <h2>Buat Akun Baru</h2>
      <input id="reg-display-name" type="text" placeholder="Nama Panggilan/Tampilan Anda">
      <input id="reg-username" type="text" placeholder="Username (tanpa @, misal: annas)">
      <input id="reg-password" type="password" placeholder="Password Kuat (min 6 karakter)">
      <textarea id="reg-bio" placeholder="Tulis bio singkat Anda (Opsional)"></textarea>
      <button onclick="register()">Daftar</button>
      <p class="link" onclick="toggleAuthScreen('login')">Sudah punya akun? Login</p>
      <p id="reg-msg" class="message"></p>
    </div>
  </div>

  <div id="main-chat-list-screen" class="app-screen">
    <div id="main-chat-list-header">
      <span class="app-title">WhatsApp</span>
      <div class="header-icons">
        <i class="fas fa-camera" title="Kamera (Simulasi)"></i>
        <i class="fas fa-search" title="Cari (Simulasi)"></i>
        <i class="fas fa-ellipsis-v" title="Opsi" onclick="showUserAdminControls()"></i>
      </div>
    </div>
    <div id="promo-banner">
        <span>Buat iklan mulai dari Rp16.377/hari</span>
        <a href="#">Mulai</a>
        <button class="close-btn" onclick="document.getElementById('promo-banner').style.display='none';"><i class="fas fa-times"></i></button>
    </div>
    <div id="chat-list-content">
      <div id="chat-list-ul">
        </div>
    </div>
    <div id="fab-chat" onclick="startChat('new-chat-partner-placeholder')"> <i class="fas fa-comment-alt"></i>
    </div>
    <div id="bottom-nav">
      <div class="nav-item active" data-nav="chat" onclick="showScreen('main-chat-list-screen'); document.querySelectorAll('#bottom-nav .nav-item').forEach(item => item.classList.remove('active')); this.classList.add('active');">
        <i class="fas fa-comment-dots"></i>
        <span>Chat</span>
      </div>
      <div class="nav-item" data-nav="calls" onclick="alert('Fitur Panggilan sedang dikembangkan!'); document.querySelectorAll('#bottom-nav .nav-item').forEach(item => item.classList.remove('active')); this.classList.add('active');">
        <i class="fas fa-phone"></i>
        <span>Panggilan</span>
      </div>
      <div class="nav-item" data-nav="updates" onclick="alert('Fitur Pembaruan sedang dikembangkan!'); document.querySelectorAll('#bottom-nav .nav-item').forEach(item => item.classList.remove('active')); this.classList.add('active');">
        <i class="fas fa-circle-notch"></i>
        <span>Pembaruan</span>
      </div>
      <div class="nav-item" data-nav="ugd" onclick="showScreen('ugd-screen'); document.querySelectorAll('#bottom-nav .nav-item').forEach(item => item.classList.remove('active')); this.classList.add('active');">
        <i class="fas fa-first-aid"></i>
        <span>UGD</span>
      </div>
    </div>
  </div>

  <div id="individual-chat-screen" class="app-screen">
    <div id="chat-header">
      <button class="back-btn" onclick="showScreen('main-chat-list-screen')"><i class="fas fa-arrow-left"></i></button>
      <div class="chat-partner-avatar" id="chat-partner-avatar"></div>
      <div class="chat-partner-info">
        <span class="chat-partner-name" id="chat-partner-name"></span>
        <span class="chat-partner-status" id="chat-partner-status"></span>
      </div>
      <div class="chat-options">
        <button title="Panggilan Video (Simulasi)" onclick="showCallScreen('video')"><i class="fas fa-video"></i></button>
        <button title="Panggilan Suara (Simulasi)" onclick="showCallScreen('audio')"><i class="fas fa-phone"></i></button>
        <button title="Opsi Lainnya"><i class="fas fa-ellipsis-v"></i></button>
      </div>
    </div>
    <div id="chat-messages">
        <div class="e2e-notice">
            <i class="fas fa-lock"></i> Pesan dan panggilan terenkripsi secara end-to-end. Hanya orang di chat ini yang bisa membaca, mendengarkan, atau membagikannya. <a href="#">Pelajari selengkapnya</a>.
        </div>
        <div class="e2e-notice" style="margin-top: 10px;">
            <i class="fas fa-clock"></i> Anda menggunakan timer default untuk pesan sementara di chat baru. Pesan baru akan hilang dari chat ini dalam 24 jam setelah dikirim, kecuali disimpan. Ketuk untuk menyetel timer default Anda sendiri.
        </div>
    </div>
    <div id="chat-input-bar">
      <div class="input-icons">
          <button title="Emoji"><i class="fas fa-grin"></i></button>
      </div>
      <div class="message-input-wrapper">
        <input id="msg-input" type="text" placeholder="Pesan" onkeypress="handleKeyPress(event)">
        <i class="fas fa-laugh smiley-icon" title="Emoji"></i> </div>
      <input type="file" id="file-input" accept="image/*,audio/*,video/*" style="display:none;">
      <button class="input-icons" title="Lampirkan File" onclick="document.getElementById('file-input').click()"><i class="fas fa-paperclip"></i></button>
      <button class="mic-send-button" title="Kirim Pesan" onclick="sendMessage()"><i class="fas fa-microphone"></i></button>
    </div>
  </div>

  <div id="admin-user-controls-screen" class="app-screen">
    <div class="controls-header">
        <button class="back-btn" onclick="showScreen('main-chat-list-screen')"><i class="fas fa-arrow-left"></i></button>
        <span>Pengaturan</span>
    </div>
    <div class="controls-body">
        <div class="controls-panel" id="user-controls-panel">
            <h4><i class="fas fa-user-cog"></i> Pengaturan Akun</h4>
            <button class="default" onclick="showEditProfileModal()"><i class="fas fa-user-edit"></i> Edit Profil & Bio</button>
            <button class="info" onclick="changePassword()"><i class="fas fa-key"></i> Ganti Password</button>
            <button class="danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <div class="controls-panel" id="admin-controls-panel" style="display:none;">
            <h4><i class="fas fa-user-shield"></i> Kontrol Admin</h4>
            <button class="info" onclick="showAllUserStats()"><i class="fas fa-chart-line"></i> Statistik Pengguna Lengkap</button>
            <button class="warning" onclick="showBanUserModal()"><i class="fas fa-user-slash"></i> Kelola Blokir Pengguna</button>
            <button class="success" onclick="showReviewRequests()"><i class="fas fa-clipboard-check"></i> Tinjau Permintaan Akun</button>
            <button class="danger" onclick="showDeleteUserModal()"><i class="fas fa-user-times"></i> Hapus Pengguna Permanen</button>
            <div id="admin-stats" class="stats"></div>
        </div>
        <p style="text-align: center; margin-top: 20px; font-size: 0.8em; color: #888;">Annas Chat v1.0.0</p>
    </div>
  </div>


  <div id="call-screen" class="app-screen">
    <div class="call-avatar" id="call-partner-avatar-lg"></div>
    <h2 id="call-partner-name-lg" style="margin-top: 20px;"></h2>
    <p class="call-status" id="call-status-text"></p>

    <div class="call-controls">
        <button class="mute-btn" title="Mute"><i class="fas fa-microphone-slash"></i></button>
        <button class="end-call-btn" title="Akhiri Panggilan" onclick="endCall()"><i class="fas fa-phone-slash"></i></button>
        <button class="speaker-btn" title="Speaker"><i class="fas fa-volume-up"></i></button>
    </div>
  </div>

  <div id="ugd-screen" class="app-screen">
    <div class="ugd-header">
        <button class="back-btn" onclick="showScreen('main-chat-list-screen')"><i class="fas fa-arrow-left"></i></button>
        <span>Unit Gawat Darurat (UGD)</span>
    </div>
    <i class="fas fa-medkit ugd-icon"></i>
    <h2>Butuh Bantuan Mendesak?</h2>
    <p>Di sini Anda bisa meminta bantuan darurat. Fitur ini hanya simulasi.</p>
    <div class="ugd-buttons">
        <button onclick="alert('Panggilan ke layanan darurat (simulasi)');"><i class="fas fa-phone-alt"></i> Panggil Layanan Darurat</button>
        <button onclick="alert('Kirim lokasi Anda (simulasi)');"><i class="fas fa-map-marker-alt"></i> Bagikan Lokasi Darurat</button>
        <button onclick="alert('Kirim pesan otomatis ke kontak darurat (simulasi)');"><i class="fas fa-sms"></i> Kirim Pesan Darurat</button>
    </div>
  </div>

  <div id="modal-backdrop">
    <div id="modal-content">
      <h3 id="modal-title"></h3>
      <div id="modal-body"></div>
      <div id="modal-actions">
        <button class="cancel-btn" onclick="closeModal()">Batal</button>
        <button id="modal-confirm-btn" class="confirm-btn"></button>
      </div>
    </div>
  </div>

  <script>
    // Request Notification permission on page load
    Notification.requestPermission();

    // Initial user data. Annas is admin.
    let users = JSON.parse(localStorage.getItem('users')) || [
      { username: 'annas', password: 'annas', displayName: 'Admin Annas', bio: 'Saya adalah Administrator Annas Chat.', role: 'admin', banned: false, profilePic: null, stats: { logins: 0, chatsSent: 0, chatsReceived: 0 } }
    ];
    let currentUser = null;
    let activeReceiver = null;
    let messages = JSON.parse(localStorage.getItem('messages')) || {}; // Store messages by sender-receiver pair
    let reviewRequests = JSON.parse(localStorage.getItem('reviewRequests')) || []; // Store ban review requests

    // --- Screen Management ---
    function showScreen(screenId) {
        const screens = document.querySelectorAll('.app-screen');
        screens.forEach(screen => {
            if (screen.id === screenId) {
                screen.classList.add('active');
                screen.classList.remove('transition-out');
            } else {
                screen.classList.remove('active');
                screen.classList.add('transition-out');
            }
        });
        // Deactivate all nav items then activate the current one
        document.querySelectorAll('#bottom-nav .nav-item').forEach(item => item.classList.remove('active'));
        const activeNavItem = document.querySelector(`#bottom-nav .nav-item[data-nav="${screenId.replace('-screen', '')}"]`);
        if(activeNavItem) activeNavItem.classList.add('active');
    }

    // Function to get current timestamp formatted
    function getTimestamp() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    // --- Loading Screen ---
    const hackerConsoleElement = document.getElementById('hacker-console');
    const loadingTextElement = document.getElementById('loading-text');

    function showLoadingScreen() {
        document.getElementById('loading-screen').classList.add('show');
        hackerConsoleElement.innerText = ''; // Clear previous text
        loadingTextElement.style.display = 'none'; // Hide text initially

        const hackerScript = [
            'Initializing Annas Chat OS v1.0.0...',
            'Establishing secure connection to server...',
            '  [OK] Server link established.',
            'Verifying user credentials...',
            '  [OK] Authentication module loaded.',
            '  [OK] User data fetched from encrypted storage.',
            'Loading core chat components...',
            '  [OK] UI/UX framework ready.',
            '  [OK] Message parsing engine initialized.',
            '  [OK] Media handler configured.',
            'Applying security patches...',
            '  [OK] End-to-end encryption active.',
            'Establishing peer-to-peer protocols...',
            '  [OK] All modules loaded. Ready for chat.'
        ];

        let lineIndex = 0;
        let charIndex = 0;
        let typingInterval;

        function typeLine() {
            if (lineIndex < hackerScript.length) {
                if (charIndex <= hackerScript[lineIndex].length) {
                    hackerConsoleElement.innerText = hackerScript[lineIndex].substring(0, charIndex);
                    charIndex++;
                    typingInterval = setTimeout(typeLine, 30); // Faster typing
                } else {
                    hackerConsoleElement.innerText += '\n'; // New line after full line
                    lineIndex++;
                    charIndex = 0;
                    typingInterval = setTimeout(typeLine, 100); // Pause before next line
                }
            } else {
                clearInterval(typingInterval);
                hackerConsoleElement.style.animation = 'none';
                hackerConsoleElement.style.borderRight = 'none';
                loadingTextElement.style.display = 'block'; // Show "Memuat Annas Chat..."
            }
        }
        typeLine();
    }

    function hideLoadingScreen() {
        document.getElementById('loading-screen').classList.remove('show');
    }

    // --- Authentication Functions ---
    function toggleAuthScreen(type) {
      if (type === 'register') {
        document.getElementById('register-card').style.display = 'block';
        document.getElementById('login-card').style.display = 'none';
        document.getElementById('register-card').style.animation = 'fadeInZoomIn 0.8s forwards ease-out';
      } else { // type === 'login'
        document.getElementById('register-card').style.display = 'none';
        document.getElementById('login-card').style.display = 'block';
        document.getElementById('login-card').style.animation = 'fadeInZoomIn 0.8s forwards ease-out';
      }
      document.getElementById('reg-msg').innerText = '';
      document.getElementById('login-msg').innerText = '';
    }

    function register() {
      const displayName = document.getElementById('reg-display-name').value.trim();
      const username = document.getElementById('reg-username').value.trim().toLowerCase(); // Store lowercase
      const password = document.getElementById('reg-password').value.trim();
      const bio = document.getElementById('reg-bio').value.trim();

      if (!displayName || !username || !password) {
        return document.getElementById('reg-msg').innerText = ' Nama panggilan, username & password harus diisi.';
      }
      if (password.length < 6) {
        return document.getElementById('reg-msg').innerText = ' Password minimal 6 karakter.';
      }
      if (users.find(u => u.username === username)) {
        return document.getElementById('reg-msg').innerText = ' Username sudah digunakan.';
      }

      users.push({ username: username, password: password, displayName: displayName, bio: bio, role: 'user', banned: false, profilePic: null, stats: { logins: 0, chatsSent: 0, chatsReceived: 0 } });
      localStorage.setItem('users', JSON.stringify(users));
      alert(' Akun berhasil dibuat! Silakan login.');
      document.getElementById('reg-display-name').value = '';
      document.getElementById('reg-username').value = '';
      document.getElementById('reg-password').value = '';
      document.getElementById('reg-bio').value = '';
      toggleAuthScreen('login');
    }

    function login() {
      const usernameInput = document.getElementById('login-username').value.trim().toLowerCase(); // Use lowercase for lookup
      const password = document.getElementById('login-password').value.trim();
      const user = users.find(u => u.username === usernameInput && u.password === password);

      if (!user) {
        return document.getElementById('login-msg').innerText = ' Username atau password salah. Mohon daftar jika belum punya akun.';
      }
      
      currentUser = user; 
      if (currentUser.banned) {
        showRequestReviewModal(); 
        return;
      }

      currentUser.stats.logins++;
      localStorage.setItem('users', JSON.stringify(users));
      
      showLoadingScreen();
      setTimeout(() => { 
        hideLoadingScreen();
        showScreen('main-chat-list-screen'); // Show main chat list
        refreshChatList();
        
        document.getElementById('login-username').value = '';
        document.getElementById('login-password').value = '';
      }, 4000); // Increased timeout for hacker effect
    }

    function logout() {
      currentUser = null;
      activeReceiver = null;
      localStorage.removeItem('currentUser'); // Clear current user from session
      showScreen('auth-screen'); // Go back to login
      document.getElementById('login-msg').innerText = 'Anda telah berhasil logout.';
      // Reset all screens
      document.getElementById('chat-list-ul').innerHTML = '';
      document.getElementById('chat-messages').innerHTML = '';
      document.getElementById('chat-partner-name').innerText = '';
      document.getElementById('chat-partner-status').innerText = '';
      document.getElementById('chat-partner-avatar').innerHTML = '';
      document.getElementById('call-screen').innerHTML = ''; // Clear call screen
    }

    // --- Main Chat List Screen Functions ---
    function refreshChatList() {
        const chatListUl = document.getElementById('chat-list-ul');
        chatListUl.innerHTML = '';

        // Add Gemini AI as a fixed chat item
        const geminiLi = document.createElement('div');
        geminiLi.className = 'chat-list-item';
        geminiLi.onclick = () => startChat('gemini');
        geminiLi.innerHTML = `
            <div class="avatar" style="background-color: #007bff;"><i class="fas fa-robot"></i></div>
            <div class="chat-info">
                <span class="chat-name">Gemini AI <i class="fas fa-badge-check admin-badge" title="Official Bot" style="color: #007bff;"></i></span>
                <span class="last-message">Asisten AI Anda.</span>
            </div>
            <div class="chat-meta">
                <span class="timestamp" style="color: var(--wa-online-status);">Online</span>
            </div>
        `;
        chatListUl.appendChild(geminiLi);

        // Add other users (excluding current user)
        const usersToDisplay = users.filter(u => u.username !== currentUser.username && !u.banned); // Exclude banned users from list
        usersToDisplay.forEach(u => {
            const li = document.createElement('div');
            li.className = 'chat-list-item';
            li.setAttribute('data-username', u.username);
            li.onclick = () => startChat(u.username);
            
            const avatarContent = u.profilePic ? `<img src="${u.profilePic}" alt="PP">` : `<span class="initials">${u.displayName.charAt(0).toUpperCase()}</span>`;
            let lastMessage = 'Belum ada pesan.';
            const chatKey1 = `${currentUser.username}-${u.username}`;
            const chatKey2 = `${u.username}-${currentUser.username}`;
            const chatHistory = messages[chatKey1] || messages[chatKey2] || [];
            if (chatHistory.length > 0) {
                const lastMsg = chatHistory[chatHistory.length - 1];
                lastMessage = lastMsg.type === 'text' ? lastMsg.content : `[${lastMsg.type.toUpperCase()}] File`;
                lastMessage = lastMsg.content.length > 30 ? lastMsg.content.substring(0, 27) + '...' : lastMsg.content;
            }

            li.innerHTML = `
                <div class="avatar">${avatarContent}</div>
                <div class="chat-info">
                    <span class="chat-name">
                        ${u.displayName}
                        ${u.role === 'admin' ? '<i class="fas fa-badge-check admin-badge" title="Admin"></i>' : ''}
                    </span>
                    <span class="last-message">${lastMessage}</span>
                </div>
                <div class="chat-meta">
                    <span class="timestamp">${chatHistory.length > 0 ? chatHistory[chatHistory.length-1].timestamp : ''}</span>
                    </div>
            `;
            chatListUl.appendChild(li);
        });
    }

    // --- Individual Chat Screen Functions ---
    function startChat(username) {
        activeReceiver = username;
        document.getElementById('chat-messages').innerHTML = '';
        document.getElementById('msg-input').value = '';

        const targetUser = users.find(u => u.username === username);
        if (username === 'gemini') {
            document.getElementById('chat-partner-name').innerHTML = 'Gemini AI <i class="fas fa-badge-check admin-badge" title="Official Bot" style="color: #007bff;"></i>';
            document.getElementById('chat-partner-avatar').innerHTML = '<i class="fas fa-robot"></i>';
            document.getElementById('chat-partner-status').innerText = 'Online';
        } else if (targetUser) {
            const avatarContent = targetUser.profilePic ? `<img src="${targetUser.profilePic}" alt="PP">` : `<span class="initials">${targetUser.displayName.charAt(0).toUpperCase()}</span>`;
            document.getElementById('chat-partner-name').innerHTML = `${targetUser.displayName} ${targetUser.role === 'admin' ? '<i class="fas fa-badge-check admin-badge" title="Admin"></i>' : ''}`;
            document.getElementById('chat-partner-avatar').innerHTML = avatarContent;
            document.getElementById('chat-partner-status').innerText = targetUser.bio || 'Online';
        } else {
            // This happens for the FAB new chat, or if a user is not found
            document.getElementById('chat-partner-name').innerText = 'Pilih Pengguna untuk Chat';
            document.getElementById('chat-partner-avatar').innerHTML = '<i class="fas fa-user"></i>';
            document.getElementById('chat-partner-status').innerText = '';
        }
        
        loadMessages();
        showScreen('individual-chat-screen');
        document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
        
        // Change send button to microphone for initial state
        const sendButton = document.querySelector('#chat-input-bar .mic-send-button');
        sendButton.innerHTML = '<i class="fas fa-microphone"></i>';
        sendButton.onclick = () => alert('Fitur rekam suara (simulasi).');

        // Update send button based on input
        document.getElementById('msg-input').oninput = function() {
            if (this.value.trim() === '') {
                sendButton.innerHTML = '<i class="fas fa-microphone"></i>';
                sendButton.onclick = () => alert('Fitur rekam suara (simulasi).');
            } else {
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
                sendButton.onclick = sendMessage;
            }
        };
    }

    function saveMessages() {
      localStorage.setItem('messages', JSON.stringify(messages));
    }

    function loadMessages() {
      document.getElementById('chat-messages').innerHTML = `
        <div class="e2e-notice">
            <i class="fas fa-lock"></i> Pesan dan panggilan terenkripsi secara end-to-end. Hanya orang di chat ini yang bisa membaca, mendengarkan, atau membagikannya. <a href="#">Pelajari selengkapnya</a>.
        </div>
        <div class="e2e-notice" style="margin-top: 10px;">
            <i class="fas fa-clock"></i> Anda menggunakan timer default untuk pesan sementara di chat baru. Pesan baru akan hilang dari chat ini dalam 24 jam setelah dikirim, kecuali disimpan. Ketuk untuk menyetel timer default Anda sendiri.
        </div>
      `; // Always show these notices
      const chatKey1 = `${currentUser.username}-${activeReceiver}`;
      const chatKey2 = `${activeReceiver}-${currentUser.username}`;
      const chatHistory = messages[chatKey1] || messages[chatKey2] || [];

      chatHistory.forEach(msg => {
        appendMessageToChat(msg);
      });
      document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
    }

    function appendMessageToChat(msg) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg-bubble ${msg.sender === currentUser.username ? 'msg-user' : 'msg-bot'}`;
        
        if (msg.type === 'text') {
            msgDiv.innerText = msg.content;
        } else if (msg.type === 'image') {
            msgDiv.innerHTML = `<img src="${msg.content}" alt="Gambar">`;
        } else if (msg.type === 'audio') {
            msgDiv.innerHTML = `<audio controls src="${msg.content}"></audio>`;
        } else if (msg.type === 'video') {
            msgDiv.innerHTML = `<video controls src="${msg.content}"></video>`;
        }
        
        const timestampSpan = document.createElement('span');
        timestampSpan.className = 'msg-timestamp';
        timestampSpan.innerText = msg.timestamp;
        msgDiv.appendChild(timestampSpan);

        document.getElementById('chat-messages').appendChild(msgDiv);
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
            event.preventDefault(); 
        }
    }

    async function sendMessage() {
      const msgInput = document.getElementById('msg-input');
      const fileInput = document.getElementById('file-input');
      const msg = msgInput.value.trim();
      const file = fileInput.files[0];

      if (!msg && !file) return;
      if (!activeReceiver) {
        alert(' Pilih pengguna atau Gemini AI untuk memulai chat.');
        return;
      }
      
      currentUser.stats.chatsSent++;
      localStorage.setItem('users', JSON.stringify(users));

      const chatKey = `${currentUser.username}-${activeReceiver}`;
      if (!messages[chatKey]) messages[chatKey] = [];

      const currentTimestamp = getTimestamp();

      if (msg) {
        const messageObject = { sender: currentUser.username, receiver: activeReceiver, type: 'text', content: msg, timestamp: currentTimestamp };
        messages[chatKey].push(messageObject);
        appendMessageToChat(messageObject);
        new Notification(` Pesan dari ${currentUser.displayName}`, { body: msg, icon: 'https://cdn-icons-png.flaticon.com/512/732/732200.png' });
      }

      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const fileContent = e.target.result;
          let fileType = 'unknown';
          if (file.type.startsWith('image')) fileType = 'image';
          else if (file.type.startsWith('audio')) fileType = 'audio';
          else if (file.type.startsWith('video')) fileType = 'video';

          const messageObject = { sender: currentUser.username, receiver: activeReceiver, type: fileType, content: fileContent, timestamp: currentTimestamp };
          messages[chatKey].push(messageObject);
          appendMessageToChat(messageObject);
          saveMessages();
          new Notification(` File dari ${currentUser.displayName}`, { body: `Mengirim ${fileType}`, icon: 'https://cdn-icons-png.flaticon.com/512/732/732200.png' });
        }
        reader.readAsDataURL(file);
      }
      
      saveMessages();
      msgInput.value = '';
      fileInput.value = ''; 
      document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;

      // Reset input button to mic
      const sendButton = document.querySelector('#chat-input-bar .mic-send-button');
      sendButton.innerHTML = '<i class="fas fa-microphone"></i>';
      sendButton.onclick = () => alert('Fitur rekam suara (simulasi).');


      // Handle Gemini AI replies
      if (activeReceiver === 'gemini') {
        const reply = await geminiReply(msg);
        const geminiMessageObject = { sender: activeReceiver, receiver: currentUser.username, type: 'text', content: reply, timestamp: getTimestamp() };
        
        messages[chatKey].push(geminiMessageObject);
        appendMessageToChat(geminiMessageObject);
        saveMessages();
        new Notification(' Gemini Membalas', { body: reply, icon: 'https://www.gstatic.com/images/branding/product/2x/gemini_2023_color_256dp.png' });
      } else {
        const receiverUser = users.find(u => u.username === activeReceiver);
        if (receiverUser) {
          receiverUser.stats.chatsReceived++;
          localStorage.setItem('users', JSON.stringify(users));
        }
      }
      if (currentUser.role === 'admin') showAdminStats();
      refreshChatList(); // Update last message in chat list
    }

    async function geminiReply(prompt) {
      if (!prompt) return 'Hai! Ada yang bisa saya bantu?';
      try {
        const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY'; // GANTI DENGAN API KEY GEMINI ASLI ANDA
        if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
          return ' Harap ganti "YOUR_GEMINI_API_KEY" dengan kunci API Gemini yang valid untuk menggunakan fitur ini.';
        }
        const res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
          }
        );
        const data = await res.json();
        const replyText = data.candidates?.[0]?.content?.parts?.[0]?.text || ' Tidak bisa membalas';
        return replyText;
      } catch (e) {
        console.error('Gemini API Error:', e);
        return ' Gagal koneksi ke Gemini API atau terjadi kesalahan. Pastikan API key Anda benar.';
      }
    }

    // --- Call Screen Functions ---
    function showCallScreen(type) {
        const targetUser = users.find(u => u.username === activeReceiver);
        const targetName = targetUser ? targetUser.displayName : (activeReceiver === 'gemini' ? 'Gemini AI' : 'Pengguna Tidak Dikenal');
        
        if (!activeReceiver || activeReceiver === 'gemini') {
            alert('Pilih pengguna lain untuk melakukan panggilan.');
            return;
        }

        const avatarContent = targetUser.profilePic ? `<img src="${targetUser.profilePic}" alt="PP">` : `<span class="initials">${targetUser.displayName.charAt(0).toUpperCase()}</span>`;
        document.getElementById('call-partner-avatar-lg').innerHTML = avatarContent;
        document.getElementById('call-partner-name-lg').innerText = targetName;
        document.getElementById('call-status-text').innerText = `Menghubungkan... (${type === 'video' ? 'Video Call' : 'Voice Call'})`;

        showScreen('call-screen');
    }

    function endCall() {
        alert('Panggilan diakhiri.');
        showScreen('individual-chat-screen'); // Return to the individual chat screen
    }

    // --- Admin & User Controls Screen ---
    function showUserAdminControls() {
        showScreen('admin-user-controls-screen');
        if (currentUser.role === 'admin') {
            document.getElementById('admin-controls-panel').style.display = 'block';
            showAdminStats();
        } else {
            document.getElementById('admin-controls-panel').style.display = 'none';
        }
        document.getElementById('user-controls-panel').style.display = 'block';
    }

    function showAdminStats() {
      let statsDiv = document.getElementById('admin-stats');
      let totalLogins = users.reduce((sum, u) => sum + u.stats.logins, 0);
      let totalChatsSent = users.reduce((sum, u) => sum + u.stats.chatsSent, 0);
      let totalChatsReceived = users.reduce((sum, u) => sum + u.stats.chatsReceived, 0);
      
      statsDiv.innerHTML = `
         Total Akun: <b>${users.length}</b><br>
         Total Login: <b>${totalLogins}</b><br>
         Pesan Terkirim: <b>${totalChatsSent}</b><br>
         Pesan Diterima: <b>${totalChatsReceived}</b><br>
         Permintaan Tinjauan: <b>${reviewRequests.length}</b>
      `;
      statsDiv.style.display = 'block';
    }

    function showAllUserStats() {
      openModal('Statistik Pengguna Lengkap', `
        <div class="modal-scrollable-content">
          <table style="width:100%; border-collapse: collapse; font-size: 0.9em; margin-top: 10px;">
            <thead>
              <tr style="background-color: #32404A;">
                <th style="padding: 10px; border: 1px solid rgba(255,255,255,0.1); text-align: left; border-top-left-radius: 8px;">Username</th>
                <th style="padding: 10px; border: 1px solid rgba(255,255,255,0.1); text-align: left;">Nama</th>
                <th style="padding: 10px; border: 1px solid rgba(255,255,255,0.1); text-align: left;">Role</th>
                <th style="padding: 10px; border: 1px solid rgba(255,255,255,0.1); text-align: left;">Login</th>
                <th style="padding: 10px; border: 1px solid rgba(255,255,255,0.1); text-align: left;">Kirim</th>
                <th style="padding: 10px; border: 1px solid rgba(255,255,255,0.1); text-align: left;">Terima</th>
                <th style="padding: 10px; border: 1px solid rgba(255,255,255,0.1); text-align: left; border-top-right-radius: 8px;">Blokir</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(u => `
                <tr style="${u.banned ? 'background-color: #4A2E2E;' : ''}">
                  <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.08);">${u.username}</td>
                  <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.08);">${u.displayName}</td>
                  <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.08);">${u.role}</td>
                  <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.08);">${u.stats.logins}</td>
                  <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.08);">${u.stats.chatsSent}</td>
                  <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.08);">${u.stats.chatsReceived}</td>
                  <td style="padding: 10px; border: 1px solid rgba(255,255,255,0.08); color: ${u.banned ? 'red' : 'green'}; font-weight: bold;">${u.banned ? 'Ya' : 'Tidak'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `, 'Tutup', null);
      document.getElementById('modal-confirm-btn').style.display = 'none'; // Hide default confirm button
    }

    function showBanUserModal() {
      const banOptions = users.filter(u => u.username !== currentUser.username && u.role !== 'admin' && !u.banned)
                               .map(u => `<option value="${u.username}">${u.displayName} (${u.username})</option>`).join('');
      const unbanOptions = users.filter(u => u.banned)
                                 .map(u => `<option value="${u.username}">${u.displayName} (${u.username})</option>`).join('');
      
      openModal('Kelola Blokir Pengguna', `
        <div style="margin-bottom: 20px;">
            <p style="color: #ddd;">Pilih pengguna yang ingin Anda <b>blokir</b>:</p>
            <select id="ban-user-select" style="width:100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); margin-top: 10px; background-color: var(--whatsapp-dark-input); color: var(--text-light);">
              ${banOptions || '<option value="">Tidak ada pengguna untuk diblokir</option>'}
            </select>
            <button class="danger" style="margin-top: 15px; background: ${banOptions ? 'var(--danger-color)' : '#555'};" ${!banOptions ? 'disabled' : ''} onclick="confirmBanUser()">
                <i class="fas fa-user-slash"></i> Blokir Pengguna Dipilih
            </button>
        </div>
        <div>
            <p style="color: #ddd;">Pilih pengguna yang ingin Anda <b>buka blokirnya</b>:</p>
            <select id="unban-user-select" style="width:100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); margin-top: 10px; background-color: var(--whatsapp-dark-input); color: var(--text-light);">
              ${unbanOptions || '<option value="">Tidak ada pengguna untuk dibuka blokirnya</option>'}
            </select>
            <button class="success" style="margin-top: 15px; background: ${unbanOptions ? 'var(--success-color)' : '#555'};" ${!unbanOptions ? 'disabled' : ''} onclick="confirmUnbanUser()">
                <i class="fas fa-check-circle"></i> Buka Blokir Pengguna Dipilih
            </button>
        </div>
      `, 'Tutup', null); 
      document.getElementById('modal-confirm-btn').style.display = 'none'; 
    }

    function confirmBanUser() {
        const selectElement = document.getElementById('ban-user-select');
        if (!selectElement || !selectElement.value) {
            alert('Pilih pengguna yang valid untuk diblokir.');
            return;
        }
        const usernameToBan = selectElement.value;
        const userIndex = users.findIndex(u => u.username === usernameToBan);
        if (userIndex > -1) {
            if (confirm(`Anda yakin ingin memblokir pengguna ${users[userIndex].displayName} (${usernameToBan}) secara permanen?`)) {
                users[userIndex].banned = true;
                localStorage.setItem('users', JSON.stringify(users));
                alert(`Pengguna ${users[userIndex].displayName} berhasil diblokir.`);
                
                // Send notification message to banned user from admin
                if (!messages[`annas-${usernameToBan}`]) messages[`annas-${usernameToBan}`] = [];
                messages[`annas-${usernameToBan}`].push({
                    sender: 'annas', // Admin's actual username
                    receiver: usernameToBan,
                    type: 'text',
                    content: 'Pesan Admin: Akun Anda telah diblokir secara permanen karena pelanggaran kebijakan. Anda dapat mengajukan banding melalui layar login.',
                    timestamp: getTimestamp()
                });
                saveMessages();

                refreshChatList(); // Update chat list to remove banned user
                showAdminStats();
                closeModal(); 
            }
        }
    }

    function confirmUnbanUser() {
        const selectElement = document.getElementById('unban-user-select');
        if (!selectElement || !selectElement.value) {
            alert('Pilih pengguna yang valid untuk dibuka blokirnya.');
            return;
        }
        const usernameToUnban = selectElement.value;
        const userIndex = users.findIndex(u => u.username === usernameToUnban);
        if (userIndex > -1) {
            if (confirm(`Anda yakin ingin membuka blokir pengguna ${users[userIndex].displayName} (${usernameToUnban})?`)) {
                users[userIndex].banned = false;
                localStorage.setItem('users', JSON.stringify(users));
                alert(`Pengguna ${users[userIndex].displayName} berhasil dibuka blokirnya.`);

                // Send notification message to unbanned user from admin
                if (!messages[`annas-${usernameToUnban}`]) messages[`annas-${usernameToUnban}`] = [];
                messages[`annas-${usernameToUnban}`].push({
                    sender: 'annas', // Admin's actual username
                    receiver: usernameToUnban,
                    type: 'text',
                    content: 'Pesan Admin: Akun Anda telah berhasil dibuka oleh administrator. Terima kasih atas kesabaran Anda.',
                    timestamp: getTimestamp()
                });
                saveMessages();

                refreshChatList(); // Update chat list to show user
                showAdminStats();
                closeModal(); 
            }
        }
    }

    function showDeleteUserModal() {
      const userOptions = users.filter(u => u.username !== currentUser.username && u.role !== 'admin')
                               .map(u => `<option value="${u.username}">${u.displayName} (${u.username})</option>`).join('');
      if (!userOptions) {
        alert('Tidak ada pengguna yang bisa dihapus.');
        return;
      }
      openModal('Hapus Pengguna Permanen', `
        <p style="color: #ddd;"><b>Peringatan:</b> Aksi ini tidak dapat dibatalkan. Semua data chat pengguna akan hilang.</p>
        <p style="color: #ddd;">Pilih pengguna yang ingin Anda hapus:</p>
        <select id="delete-user-select" style="background-color: var(--whatsapp-dark-input); color: var(--text-light); border: 1px solid rgba(255,255,255,0.1);">
          ${userOptions}
        </select>
      `, 'Hapus Sekarang', () => {
        const usernameToDelete = document.getElementById('delete-user-select').value;
        const userIndex = users.findIndex(u => u.username === usernameToDelete);
        if (userIndex > -1) {
          if (confirm(`ANDA YAKIN INGIN MENGHAPUS PENGGUNA ${users[userIndex].displayName} (${usernameToDelete}) BESERTA SEMUA DATANYA? TINDAKAN INI PERMANEN!`)) {
            users.splice(userIndex, 1);
            for (const key in messages) {
              if (key.includes(usernameToDelete)) {
                delete messages[key];
              }
            }
            localStorage.setItem('users', JSON.stringify(users));
            saveMessages();
            alert(`Pengguna ${usernameToDelete} berhasil dihapus secara permanen.`);
            refreshChatList();
            showAdminStats();
            if (activeReceiver === usernameToDelete) {
                activeReceiver = null;
                showScreen('main-chat-list-screen'); // Go back to main list
            }
          }
        }
        closeModal();
      });
      document.getElementById('modal-confirm-btn').classList.add('danger'); // Make button red
    }

    function showReviewRequests() {
        if (reviewRequests.length === 0) {
            openModal('Permintaan Tinjauan Akun', '<p style="color: #ddd;">Tidak ada permintaan tinjauan akun saat ini.</p>', 'Oke', null);
            document.getElementById('modal-confirm-btn').style.display = 'block'; // Show 'Oke' button
            return;
        }

        const reviewHtml = reviewRequests.map((req, index) => `
            <div class="review-request-item">
                <p><strong>Pengguna:</strong> ${req.username}</p>
                <p><strong>Alasan:</strong> ${req.reason}</p>
                <div class="actions">
                    <button class="success" onclick="processReviewRequest(${index}, 'accept')"><i class="fas fa-check"></i> Terima</button>
                    <button class="danger" onclick="processReviewRequest(${index}, 'reject')"><i class="fas fa-times"></i> Tolak</button>
                </div>
            </div>
        `).join('');

        openModal('Permintaan Tinjauan Akun', `<div class="modal-scrollable-content">${reviewHtml}</div>`, 'Tutup', null);
        document.getElementById('modal-confirm-btn').style.display = 'none'; // Hide default confirm button for multi-action modal
    }

    function processReviewRequest(index, action) {
        const request = reviewRequests[index];
        const userIndex = users.findIndex(u => u.username === request.username);

        if (userIndex === -1) {
            alert('Pengguna tidak ditemukan.');
            reviewRequests.splice(index, 1);
            localStorage.setItem('reviewRequests', JSON.stringify(reviewRequests));
            showReviewRequests();
            showAdminStats();
            return;
        }

        const targetUser = users[userIndex];
        let responseMessage = '';

        if (action === 'accept') {
            targetUser.banned = false;
            responseMessage = `Pemberitahuan Sistem: Administrator telah meninjau banding Anda dan akun Anda berhasil dibuka. Anda kini dapat login dan menggunakan Annas Chat kembali.`;
            alert(`Akun ${targetUser.username} berhasil dibuka. Pesan notifikasi akan dikirim.`);
        } else { 
            responseMessage = `Pemberitahuan Sistem: Administrator telah meninjau banding Anda dan akun Anda ditolak untuk dibuka. Akun Anda tetap diblokir.`;
            alert(`Akun ${targetUser.username} ditolak untuk dibuka. Pesan notifikasi akan dikirim.`);
        }

        // Send message from 'annas' (admin) to the user's chat history
        // Create a unique chat key for admin-user communication
        const adminChatKey = `annas-${targetUser.username}`; 
        if (!messages[adminChatKey]) messages[adminChatKey] = [];
        messages[adminChatKey].push({
            sender: 'annas', // Admin's actual username
            receiver: targetUser.username,
            type: 'text',
            content: responseMessage,
            timestamp: getTimestamp()
        });
        saveMessages();


        reviewRequests.splice(index, 1);
        localStorage.setItem('reviewRequests', JSON.stringify(reviewRequests));
        localStorage.setItem('users', JSON.stringify(users));
        
        refreshChatList(); 
        showAdminStats(); 
        showReviewRequests(); 
    }

    // --- User Control Functions ---
    function showEditProfileModal() {
      const fileInputHtml = `<input type="file" id="profile-pic-input" accept="image/*" style="display:none;" onchange="previewProfilePic(event)">`;

      openModal('Edit Profil Anda', `
        <div class="profile-pic-upload-container">
            <div class="profile-pic-preview" id="profile-pic-preview">
                ${currentUser.profilePic ? `<img src="${currentUser.profilePic}" alt="PP">` : `<span class="initials">${currentUser.displayName.charAt(0).toUpperCase()}</span>`}
            </div>
            <label for="profile-pic-input" class="upload-btn"><i class="fas fa-camera"></i> Unggah Foto Profil</label>
            ${fileInputHtml}
        </div>
        <p style="color: #ddd;">Nama Panggilan Anda:</p>
        <input type="text" id="edit-display-name" placeholder="Nama Panggilan Baru" value="${currentUser.displayName}">
        <p style="color: #ddd;">Username Anda:</p>
        <input type="text" id="edit-username" placeholder="Username Baru (tidak bisa diubah)" value="${currentUser.username}" disabled>
        <p style="color: #ddd;">Bio/Status Anda:</p>
        <textarea id="edit-bio" placeholder="Tulis bio singkat Anda">${currentUser.bio || ''}</textarea>
      `, 'Simpan Perubahan', () => {
        const newDisplayName = document.getElementById('edit-display-name').value.trim();
        const newBio = document.getElementById('edit-bio').value.trim();
        const newProfilePicFile = document.getElementById('profile-pic-input').files[0];

        let profilePicUpdated = false;

        if (newDisplayName && newDisplayName !== currentUser.displayName) {
          currentUser.displayName = newDisplayName;
        }
        if (newBio !== currentUser.bio) { 
          currentUser.bio = newBio;
        }

        if (newProfilePicFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                currentUser.profilePic = e.target.result;
                localStorage.setItem('users', JSON.stringify(users));
                alert('Profil berhasil diperbarui!');
                refreshChatList(); // Update main list
                closeModal();
            }
            reader.readAsDataURL(newProfilePicFile);
        } else {
            localStorage.setItem('users', JSON.stringify(users));
            alert('Profil berhasil diperbarui!');
            refreshChatList();
            closeModal();
        }
      });
    }

    function previewProfilePic(event) {
        const reader = new FileReader();
        reader.onload = function(){
            const output = document.getElementById('profile-pic-preview');
            output.innerHTML = `<img src="${reader.result}" alt="Preview">`;
        };
        reader.readAsDataURL(event.target.files[0]);
    }

    function changePassword() {
      openModal('Ganti Password', `
        <input type="password" id="old-password" placeholder="Password Lama Anda">
        <input type="password" id="new-password" placeholder="Password Baru (min 6 karakter)">
        <input type="password" id="confirm-new-password" placeholder="Konfirmasi Password Baru">
      `, 'Ganti Password', () => {
        const oldPass = document.getElementById('old-password').value;
        const newPass = document.getElementById('new-password').value;
        const confirmNewPass = document.getElementById('confirm-new-password').value;

        if (oldPass !== currentUser.password) {
          alert('Password lama salah.');
          return;
        }
        if (newPass.length < 6) {
          alert('Password baru minimal 6 karakter.');
          return;
        }
        if (newPass !== confirmNewPass) {
          alert('Konfirmasi password baru tidak cocok.');
          return;
        }

        currentUser.password = newPass;
        localStorage.setItem('users', JSON.stringify(users));
        alert('Password berhasil diganti.');
        closeModal();
      });
    }

    // --- Ban Review Request for Banned Users ---
    function showRequestReviewModal() {
        openModal('Akun Anda Diblokir', `
            <p style="text-align: center; color: var(--danger-color); font-weight: bold;"><i class="fas fa-ban"></i> Akun Anda telah diblokir.</p>
            <p style="color: #ddd;">Untuk mengajukan tinjauan dan membuka kembali akun Anda, silakan berikan alasan mengapa Anda merasa akun Anda harus diaktifkan kembali:</p>
            <textarea id="review-reason" placeholder="Ketik alasan Anda di sini..." rows="5" style="width:100%; margin-top:15px; background-color: var(--whatsapp-dark-input); color: var(--text-light); border: 1px solid rgba(255,255,255,0.1);"></textarea>
        `, 'Kirim Permintaan Tinjauan', () => {
            const reason = document.getElementById('review-reason').value.trim();
            if (!reason) {
                alert('Alasan tidak boleh kosong.');
                return;
            }

            if (reviewRequests.some(req => req.username === currentUser.username)) {
                alert('Anda sudah memiliki permintaan tinjauan yang tertunda. Mohon tunggu balasan administrator.');
                closeModal();
                return;
            }

            reviewRequests.push({
                username: currentUser.username,
                reason: reason,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('reviewRequests', JSON.stringify(reviewRequests));
            alert('Permintaan tinjauan Anda telah berhasil dikirim ke administrator. Mohon tunggu balasan.');
            closeModal();
            // User is still blocked, stay on login screen
        });
        document.getElementById('modal-actions').style.justifyContent = 'center'; 
        document.getElementById('modal-confirm-btn').classList.remove('cancel-btn'); 
        document.getElementById('modal-confirm-btn').classList.add('confirm-btn'); 
        // Hide cancel button if only review is allowed
        document.querySelector('#modal-actions .cancel-btn').style.display = 'none';
    }


    // --- Universal Modal Functions ---
    function openModal(title, bodyHtml, confirmText, onConfirm) {
      document.getElementById('modal-title').innerText = title;
      document.getElementById('modal-body').innerHTML = bodyHtml;
      const confirmBtn = document.getElementById('modal-confirm-btn');
      confirmBtn.innerText = confirmText;
      confirmBtn.classList.remove('danger', 'success', 'info', 'default'); // Reset classes

      if (onConfirm) {
        confirmBtn.onclick = onConfirm;
        confirmBtn.style.display = 'block';
        document.querySelector('#modal-actions .cancel-btn').style.display = 'block'; // Show cancel by default
      } else {
        confirmBtn.style.display = 'none'; // Hide confirm if no action
        document.querySelector('#modal-actions .cancel-btn').style.display = 'block'; // Still show 'Tutup' button
        document.querySelector('#modal-actions .cancel-btn').innerText = confirmText; // Use confirmText for cancel button if no confirm action
        document.querySelector('#modal-actions .cancel-btn').onclick = closeModal;
      }
      document.getElementById('modal-backdrop').classList.add('show');
      document.getElementById('modal-actions').style.justifyContent = onConfirm ? 'flex-end' : 'center'; 
    }

    function closeModal() {
      document.getElementById('modal-backdrop').classList.remove('show');
      document.getElementById('modal-body').innerHTML = ''; // Clear modal body content
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
        showLoadingScreen();
        // Load currentUser from localStorage if exists
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            currentUser = users.find(u => u.username === storedUser);
        }

        setTimeout(() => {
            hideLoadingScreen();
            if (currentUser && !currentUser.banned) { // Check if user exists and is not banned
                showScreen('main-chat-list-screen');
                refreshChatList();
            } else if (currentUser && currentUser.banned) { // If banned, show review modal
                showScreen('auth-screen'); // Stay on auth screen
                toggleAuthScreen('login'); // Ensure login form is visible
                document.getElementById('login-username').value = currentUser.username;
                document.getElementById('login-password').focus(); // Prompt for password
                showRequestReviewModal();
            }
             else {
                showScreen('auth-screen');
                toggleAuthScreen('login'); // Default to login screen
            }
        }, 4000); // Increased timeout for hacker effect animation
    });
  </script>
</body>
</html>